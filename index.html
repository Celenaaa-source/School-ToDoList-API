<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School To-Do List</title>

    <!-- CSS Internal -->
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f7f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        #app {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 800px;
        }

        #auth-container, #dashboard-container {
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #45a049;
        }

        #login-button {
            background-color: #4285F4; /* Google Blue */
        }

        #login-button:hover {
            background-color: #357ae8;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        #user-greeting {
            font-weight: bold;
            color: #555;
        }

        #logout-button {
            background-color: #f44336;
        }

        #logout-button:hover {
            background-color: #da190b;
        }

        .day-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .day-selector button {
            background-color: #e0e0e0;
            color: #333;
            border: 1px solid #ccc;
            margin: 5px;
        }

        .day-selector button.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        #task-list {
            text-align: left;
        }

        .task-item {
            display: flex;
            align-items: center;
            background-color: #f9f9f9;
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .task-item.completed {
            background-color: #e6ffe6;
        }

        .task-item input[type="checkbox"] {
            margin-right: 15px;
            transform: scale(1.5);
            cursor: pointer;
        }

        .task-details {
            flex-grow: 1;
        }

        .task-details h3 {
            margin: 0;
            color: #333;
            font-size: 1.1em;
        }

        .task-details p {
            margin: 5px 0 0;
            color: #666;
            font-size: 0.9em;
        }

        .admin-status {
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 4px;
            margin-left: 10px;
            white-space: nowrap;
        }

        .admin-status.pending {
            background-color: #ffeb3b;
            color: #333;
        }

        .admin-status.approved {
            background-color: #8bc34a;
            color: white;
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script> <!-- Firestore tidak wajib, tapi kadang berguna -->
</head>
<body>
    <div id="app">
        <div id="auth-container">
            <h1>School To-Do List</h1>
            <p>Login dengan akun Google Anda untuk melanjutkan.</p>
            <button id="login-button">Login with Google</button>
        </div>

        <div id="dashboard-container" style="display: none;">
            <div class="header">
                <span id="user-greeting">Halo, [Nama Pengguna]!</span>
                <button id="logout-button">Logout</button>
            </div>
            <h1>Daftar Tugas Harian</h1>
            <div class="day-selector">
                <button data-day="Senin" class="active">Senin</button>
                <button data-day="Selasa">Selasa</button>
                <button data-day="Rabu">Rabu</button>
                <button data-day="Kamis">Kamis</button>
                <button data-day="Jumat">Jumat</button>
            </div>
            <div id="task-list">
                <!-- Tugas akan dimuat di sini oleh JavaScript -->
            </div>
        </div>
    </div>

    <!-- JavaScript Internal -->
    <script>
        // 1. Konfigurasi Firebase Anda (Ganti dengan konfigurasi dari Firebase Console Anda)
        const firebaseConfig = {
            apiKey: "AIzaSyCt270LSDtenYrUwDklX49eXno22pJKwWM",
            authDomain: "schooltodolist-33f05.firebaseapp.com",
            projectId: "schooltodolist-33f05",
            storageBucket: "schooltodolist-33f05.firebasestorage.app",
            messagingSenderId: "92850422234",
            appId: "1:92850422234:web:28cb16300c63126cbbc0e3",
  measurementId: "G-3407L7BB0G"
};

        // Inisialisasi Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();

        // Elemen DOM
        const authContainer = document.getElementById('auth-container');
        const dashboardContainer = document.getElementById('dashboard-container');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const userGreeting = document.getElementById('user-greeting');
        const daySelector = document.querySelector('.day-selector');
        const taskList = document.getElementById('task-list');

        let currentUser = null; // Menyimpan informasi pengguna yang sedang login
        let currentDay = "Senin"; // Hari default

        // Jadwal Pelajaran (Data Frontend)
        const schedule = {
            "Senin": [
                { subject: "Matematika Tk. Lanjut", teacher: "Slamet Riadi" },
                { subject: "PKWU", teacher: "Istiâ€™anah" },
                { subject: "Seni Budaya", teacher: "Dyah Iswarini" },
                { subject: "Bahasa Inggris", teacher: "Tjitjik Siti Munifah" },
                { subject: "Mulok Jawa", teacher: "Eksa Hertin Probowati" },
                { subject: "Informatika", teacher: "Sigit Hadi Waluyo" }
            ],
            "Selasa": [
                { subject: "Matematika Tk. Lanjut", teacher: "Slamet Riadi" },
                { subject: "Matematika", teacher: "Suharto" },
                { subject: "Bahasa Indonesia", teacher: "Muh. Sholehuddin" },
                { subject: "PABP", teacher: "Saleh" },
                { subject: "Sejarah", teacher: "Mis Endang Sutin" },
                { subject: "Geografi", teacher: "Suci Romadoni" }
            ],
            "Rabu": [
                { subject: "PPKn", teacher: "Solihin Bahari" },
                { subject: "Bahasa Inggris", teacher: "Tjitjik Siti Munifah" },
                { subject: "Geografi", teacher: "Suci Romadoni" },
                { subject: "Informatika", teacher: "Sigit Hadi Waluyo" },
                { subject: "Bahasa Indonesia", teacher: "Muh. Sholehuddin" },
                { subject: "Fisika", teacher: "Ita Dwi Irawati" }
            ],
            "Kamis": [
                { subject: "Fisika", teacher: "Ita Dwi Irawati" },
                { subject: "Matematika", teacher: "Suharto" },
                { subject: "Matematika Tk. Lanjut", teacher: "Slamet Riadi" },
                { subject: "Informatika", teacher: "Sigit Hadi Waluyo" },
                { subject: "BK", teacher: "Anung Bayu Saptowo" },
                { subject: "Geografi", teacher: "Suci Romadoni" }
            ],
            "Jumat": [
                { subject: "PJOK", teacher: "Tito Januar" },
                { subject: "Fisika", teacher: "Ita Dwi Irawati" }
            ]
        };

        // Fungsi untuk mengelola UI berdasarkan status login
        function updateUI(user) {
            if (user) {
                currentUser = user;
                authContainer.style.display = 'none';
                dashboardContainer.style.display = 'block';
                userGreeting.textContent = `Halo, ${user.displayName || user.email}!`;
                renderTasks(currentDay); // Muat tugas untuk hari ini
            } else {
                currentUser = null;
                authContainer.style.display = 'block';
                dashboardContainer.style.display = 'none';
                taskList.innerHTML = ''; // Kosongkan daftar tugas
            }
        }

        // Event listener untuk Login Google
        loginButton.addEventListener('click', () => {
            auth.signInWithPopup(provider)
                .then((result) => {
                    // Pengguna berhasil login
                    console.log('User logged in:', result.user);
                })
                .catch((error) => {
                    console.error('Login error:', error);
                    alert('Gagal login dengan Google: ' + error.message);
                });
        });

        // Event listener untuk Logout
        logoutButton.addEventListener('click', () => {
            auth.signOut()
                .then(() => {
                    console.log('User logged out');
                })
                .catch((error) => {
                    console.error('Logout error:', error);
                    alert('Gagal logout: ' + error.message);
                });
        });

        // Memantau perubahan status autentikasi
        auth.onAuthStateChanged((user) => {
            updateUI(user);
        });

        // Fungsi untuk render daftar tugas
        async function renderTasks(day) {
            taskList.innerHTML = 'Loading tasks...';
            const dailySchedule = schedule[day];
            if (!dailySchedule || dailySchedule.length === 0) {
                taskList.innerHTML = '<p>Tidak ada tugas untuk hari ini.</p>';
                return;
            }

            try {
                // Panggil Google Apps Script untuk mendapatkan status tugas dari Google Sheet
                const response = await fetch('https://script.google.com/macros/s/AKfycbzJtgajo4DWLGy9SnyW9FqQfGpHrjsh3cSa9Brc-kdVIHdh0QsXjYPhJYEHZ_HxyEDMig/exec' + day + '&email=' + currentUser.email);
                const taskStatus = await response.json(); // Akan berisi array objek { subject, isCompleted, adminApproved, id }

                taskList.innerHTML = ''; // Kosongkan sebelum mengisi
                dailySchedule.forEach((item, index) => {
                    const taskData = taskStatus.find(ts => ts.subject === item.subject);
                    const isCompleted = taskData ? (taskData.isCompleted === true || taskData.isCompleted === 'TRUE') : false; // Handle boolean dari GS
                    const adminApproved = taskData ? (taskData.adminApproved === true || taskData.adminApproved === 'TRUE') : false; // Handle boolean dari GS
                    const taskId = taskData ? taskData.id : `task-${day}-${index}`; // Gunakan ID dari GS jika ada

                    const taskItem = document.createElement('div');
                    taskItem.className = `task-item ${isCompleted ? 'completed' : ''}`;
                    taskItem.dataset.taskId = taskId;

                    taskItem.innerHTML = `
                        <input type="checkbox" id="${taskId}" ${isCompleted ? 'checked' : ''} ${isCompleted ? 'disabled' : ''}>
                        <div class="task-details">
                            <h3>${item.subject}</h3>
                            <p>Guru: ${item.teacher}</p>
                        </div>
                        ${isCompleted ? `<span class="admin-status ${adminApproved ? 'approved' : 'pending'}">${adminApproved ? 'Disetujui Admin' : 'Menunggu Persetujuan'}</span>` : ''}
                    `;
                    taskList.appendChild(taskItem);

                    const checkbox = taskItem.querySelector(`#${taskId}`);
                    // Hanya tambahkan event listener jika belum selesai
                    if (!isCompleted) {
                        checkbox.addEventListener('change', () => handleTaskCompletion(taskId, item.subject, item.teacher, day, checkbox.checked));
                    }
                });
            } catch (error) {
                console.error("Error fetching tasks:", error);
                taskList.innerHTML = '<p>Gagal memuat tugas. Silakan coba lagi nanti.</p>';
            }
        }

        // Fungsi untuk menangani penandaan tugas selesai
        async function handleTaskCompletion(taskId, subject, teacher, day, isCompleted) {
            if (!currentUser) {
                alert("Anda harus login untuk menandai tugas.");
                return;
            }

            // Konfirmasi dari pengguna
            const confirmation = confirm(`Apakah Anda yakin ingin menandai "${subject}" sebagai ${isCompleted ? 'selesai' : 'belum selesai'}?`);
            if (!confirmation) {
                // Batalkan perubahan checkbox jika pengguna membatalkan
                const checkbox = document.getElementById(taskId);
                checkbox.checked = !isCompleted;
                return;
            }

            try {
                const response = await fetch('YOUR_APPS_SCRIPT_WEB_APP_URL', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'markTask',
                        id: taskId,
                        subject: subject,
                        teacher: teacher,
                        day: day,
                        email: currentUser.email,
                        isCompleted: isCompleted,
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert('Tugas berhasil diperbarui!');
                    renderTasks(day); // Muat ulang tugas untuk memperbarui tampilan
                } else {
                    alert('Gagal memperbarui tugas: ' + result.message);
                    // Kembalikan status checkbox jika gagal
                    const checkbox = document.getElementById(taskId);
                    checkbox.checked = !isCompleted;
                }
            } catch (error) {
                console.error("Error marking task:", error);
                alert('Terjadi kesalahan saat memperbarui tugas.');
                // Kembalikan status checkbox jika gagal
                const checkbox = document.getElementById(taskId);
                checkbox.checked = !isCompleted;
            }
        }


        // Event listener untuk pemilihan hari
        daySelector.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON') {
                // Hapus kelas 'active' dari semua tombol
                document.querySelectorAll('.day-selector button').forEach(btn => btn.classList.remove('active'));
                // Tambahkan kelas 'active' ke tombol yang diklik
                event.target.classList.add('active');
                currentDay = event.target.dataset.day;
                if (currentUser) {
                    renderTasks(currentDay);
                }
            }
        });

        // Inisialisasi: set hari default menjadi hari ini
        const days = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        const todayIndex = new Date().getDay(); // 0 = Minggu, 1 = Senin, dst.
        let initialDay = days[todayIndex];
        if (todayIndex === 0 || todayIndex === 6) { // Jika hari Minggu atau Sabtu
            initialDay = "Senin"; // Default ke Senin
        }

        currentDay = initialDay;
        const initialDayButton = document.querySelector(`.day-selector button[data-day="${initialDay}"]`);
        if (initialDayButton) {
            initialDayButton.classList.add('active');
        }
    </script>
</body>
</html>
